
# 自己实现读写分离

> 考虑到如果只是为了实现读写分离，使用 mycat2 这种数据中间件会不会比较重，于是考虑自己实现一个。

设计目标：
- 业务代码零侵入
- 简单易用，业务代码尽可能不做改动
- 符合现有项目场景
    - 例如 OMS 项目中 数据库名称.表名 的跨库查询，跨库子查询，跨库 join 查询


![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/32dfaf1eb21f43c48672ef923f40bec1.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)


![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/48c3f272d4114e2b96c9c6b31b98aa95.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)



##### 使用

###### 安装

maven
```
<dependency>
	<groupId>com.lp</groupId>
	<artifactId>routing-datasource</artifactId>
	<version>1.0-SNAPSHOT</version>
</dependency>
```

使用起来非常简单，只需要在 spring boot 配置文件中增加多数据源的配置，以及可写数据源名称和可读数据源名称即可，支持自定义负载均衡策略，默认使用的是随机策略。同时需要在 spring boot 启动主类上添加 `@EnableRoutingDataSource` 注解。

![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/0cdcda067714496c91edcca06dd0fcd0.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)


![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/f6d63e85c9df4a2c830a255f96083b9e.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)

![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/45be2953bb1044e2874b6c8bdb209d27.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)


## Beanchmark

#### SQL 解析 Beanchmark

> 本次基准测试针对 JSqlParser 实现进行测试, SQL 复杂度越高解析消耗的平均时长会越高

平均时间

![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/cc3523f0a6594e339499f0f7ba323b22.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)


采样时间

![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/2ec633059cf84b4d8b3fbe695a07de0b.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)


单次操作时间

![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/0c7792f9c7f84efc8e56a23ad334110c.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)


吞吐量

![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/80aec812af2446b48875195633b93673.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)


## 集成 spring , mybatis 测试

提供对 application.properties 格式配置文件支持
```
######### routing configuration #############################
routing.dataSources.write_0.type=READ_WRITE
routing.dataSources.write_0.weight=99
routing.dataSources.write_0.dataSourceClass=com.zaxxer.hikari.HikariDataSource
#routing.dataSources.write_0.properties.driverClassName=org.h2.Driver
routing.dataSources.write_0.properties.jdbcUrl=jdbc:h2:mem:~/test1;FILE_LOCK=SOCKET;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=TRUE;AUTO_RECONNECT=TRUE;IGNORECASE=TRUE;
routing.dataSources.write_0.properties.username=sa
routing.dataSources.write_0.properties.password=
routing.dataSources.write_0.properties.minIdle=5
routing.dataSources.write_0.properties.maxPoolSize=30
routing.dataSources.write_0.properties.connectionTimeout=30000
routing.dataSources.write_0.properties.isAutoCommit=false
routing.dataSources.write_0.properties.isReadOnly=false

routing.dataSources.read_0.type=READ
routing.dataSources.read_0.weight=6
routing.dataSources.read_0.dataSourceClass=com.zaxxer.hikari.HikariDataSource
#routing.dataSources.read_0.driverClassName=org.h2.Driver
routing.dataSources.read_0.properties.jdbcUrl=jdbc:h2:mem:~/test2;FILE_LOCK=SOCKET;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=TRUE;AUTO_RECONNECT=TRUE;IGNORECASE=TRUE;
routing.dataSources.read_0.properties.username=sa
routing.dataSources.read_0.properties.password=
routing.dataSources.read_0.properties.minIdle=10
routing.dataSources.read_0.properties.maxPoolSize=30
routing.dataSources.read_0.properties.connectionTimeout=40000
routing.dataSources.read_0.properties.isAutoCommit=false
routing.dataSources.read_0.properties.isReadOnly=true

routing.dataSources.read_1.type=READ
routing.dataSources.read_1.weight=10
routing.dataSources.read_1.dataSourceClass=com.zaxxer.hikari.HikariDataSource
#routing.dataSources.read_1.properties.driverClassName=org.h2.Driver
routing.dataSources.read_1.properties.jdbcUrl=jdbc:h2:mem:~/test3;FILE_LOCK=SOCKET;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=TRUE;AUTO_RECONNECT=TRUE;IGNORECASE=TRUE;
routing.dataSources.read_1.properties.username=sa
routing.dataSources.read_1.properties.password=
routing.dataSources.read_1.properties.minIdle=15
routing.dataSources.read_1.properties.maxPoolSize=30
routing.dataSources.read_1.properties.connectionTimeout=60000
routing.dataSources.read_1.properties.isAutoCommit=false
routing.dataSources.read_1.properties.isReadOnly=true

routing.writeDataSource=write_0
routing.readDataSources[0]=read_0
routing.readDataSources[1]=read_1

# table routing rule
routing.rules.tables.employee.write_0.sqlTypes[0]=INSERT
routing.rules.tables.employee.write_0.sqlTypes[1]=UPDATE
routing.rules.tables.employee.write_0.sqlTypes[2]=DELETE
routing.rules.tables.employee.write_0.sqlTypes[3]=OTHER

routing.rules.tables.employee.read_0.sqlTypes[0]=SELECT
routing.rules.tables.employee.read_1.sqlTypes[0]=SELECT
```

提供对 application.yaml 格式配置文件支持
```
############################# routing configuration #############################

routing:
  dataSources:
    write_0:
      type: READ_WRITE
      weight: 99
      dataSourceClass: com.zaxxer.hikari.HikariDataSource
      properties:
        jdbcUrl: jdbc:h2:mem:~/test1;FILE_LOCK=SOCKET;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=TRUE;AUTO_RECONNECT=TRUE;IGNORECASE=TRUE;
        username: xa
        password:
        minIdle: 5
        maxPoolSize: 30
        connectionTimeout: 30000
        isAutoCommit: false
        isReadOnly: false

    read_0:
      type: READ
      weight: 6
      dataSourceClass: com.zaxxer.hikari.HikariDataSource
      properties:
        jdbcUrl: jdbc:h2:mem:~/test2;FILE_LOCK=SOCKET;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=TRUE;AUTO_RECONNECT=TRUE;IGNORECASE=TRUE;
        username: xa
        password:
        minIdle: 10
        maxPoolSize: 30
        connectionTimeout: 40000
        isAutoCommit: false
        isReadOnly: true

    read_1:
      type: READ
      weight: 10
      dataSourceClass: com.zaxxer.hikari.HikariDataSource
      properties:
        jdbcUrl: jdbc:h2:mem:~/test3;FILE_LOCK=SOCKET;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=TRUE;AUTO_RECONNECT=TRUE;IGNORECASE=TRUE;
        username: xa
        password:
        minIdle: 15
        maxPoolSize: 30
        connectionTimeout: 60000
        isAutoCommit: false
        isReadOnly: true

  writeDataSource: write_0
  readDataSources:
    - read_0
    - read_1

  rules:
# 基于指定表的路由策略，可以针对指定的表配置访问该表时可以通过那些数据源，同时可以限制 sql 语句类型 ，比如访问 employee 如果 sql 是 INSERT ，UPDATE ，DELETE ， OTHER 时可以使用 write_0 数据源
    tables:
      employee:
        write_0:
          sqlTypes:
            - INSERT
            - UPDATE
            - DELETE
            - OTHER
        read_0:
          sqlTypes:
            - SELECT
        read_1:
          sqlTypes:
            - SELECT
```

![](https://devx-blog-images.oss-cn-beijing.aliyuncs.com/images/20250108/9fd8775d156a4588a36baf74ce099b4e.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)
